<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Dashboard | Digital Learning Nabha</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .dashboard-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .filters {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    .filter-group label {
      margin-bottom: 5px;
      font-weight: bold;
    }
    .filter-group select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .progress-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .progress-table th, .progress-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    .progress-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    .progress-bar {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-fill {
      height: 20px;
      background-color: #4CAF50;
      text-align: center;
      color: white;
      font-size: 12px;
      line-height: 20px;
    }
    .notes-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }
    .save-notes-btn {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 5px;
    }
    .save-notes-btn:hover {
      background-color: #1976D2;
    }
    .student-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      background-color: #f9f9f9;
    }
    .student-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .course-info {
      margin-bottom: 10px;
    }
    .quiz-results {
      margin-top: 10px;
    }
    .quiz-result {
      background-color: white;
      padding: 10px;
      margin-bottom: 5px;
      border-radius: 4px;
      border-left: 4px solid #4CAF50;
    }
    .view-toggle {
      text-align: center;
      margin-bottom: 20px;
    }
    .view-toggle button {
      padding: 10px 20px;
      margin: 0 10px;
      border: 1px solid #ddd;
      background-color: white;
      cursor: pointer;
      border-radius: 4px;
    }
    .view-toggle button.active {
      background-color: #4CAF50;
      color: white;
    }
    header {
      background-color: #4CAF50;
      color: white;
      padding: 10px 0;
      text-align: center;
    }
    header .logo {
      font-size: 24px;
      font-weight: bold;
    }
    header nav {
      margin-top: 10px;
    }
    header nav a {
      color: white;
      text-decoration: none;
      margin: 0 15px;
    }
    header nav a:hover {
      text-decoration: underline;
    }
    footer {
      text-align: center;
      padding: 10px 0;
      background-color: #f2f2f2;
      margin-top: 20px;
    }
    footer p {
      margin: 0;
      color: #666;
    }
    .btn {
      display: inline-block;
      padding: 10px 20px;
      margin: 10px 0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
    }
    .btn.success {
      background-color: #4CAF50;
      color: white;
    }
    .btn.success:hover {
      background-color: #45a049;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    .card {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .card h2 {
      font-size: 18px;
      margin-bottom: 10px;
    }
    .card p {
      margin-bottom: 15px;
      color: #555;
    }
    .card table {
      width: 100%;
      border-collapse: collapse;
    }
    .card table th, .card table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    .card table th {
      background-color: #f9f9f9;
      font-weight: bold;
    }
    .card ul {
      list-style-type: none;
      padding: 0;
    }
    .card ul li {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card ul li button {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">Digital Learning Nabha</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="#" onclick="logout()">Logout</a>
    </nav>
  </header>
  <main>
    <section class="dashboard">
      <h1>Welcome, Teacher!</h1>
      <div class="dashboard-grid">
        <div class="card">
          <h2>Student Progress</h2>
          <p>View and track studentsâ€™ course completion and quiz scores.</p>
          <!-- Example Table -->
          <table class="progress-table">
            <thead>
              <tr>
                <th>Student</th>
                <th>Course</th>
                <th>Progress</th>
                <th>Last Accessed</th>
                <th>Quiz Results</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="progressTableBody">
            </tbody>
          </table>
        </div>
        <div class="card">
          <h2>Course Management</h2>
          <button class="btn success">Add New Course</button>
          <ul>
            <li>Mathematics <button>Edit</button> <button>Remove</button></li>
            <li>Science <button>Edit</button> <button>Remove</button></li>
            <li>English <button>Edit</button> <button>Remove</button></li>
          </ul>
        </div>
        <div class="card">
          <h2>Announcements</h2>
          <form>
            <textarea placeholder="Write announcement for students..." rows="3" style="width:100%;"></textarea>
            <button type="submit" class="btn success">Post</button>
          </form>
          <ul>
            <li>Quiz for Science will be held on Friday.</li>
            <li>New English course material uploaded.</li>
          </ul>
        </div>
      </div>
    </section>
  </main>
  <footer>
    <p>&copy; 2025 Digital Learning Nabha. All Rights Reserved.</p>
  </footer>
  <script src="api-client.js"></script>
  <script>
    let allProgress = [];
    let allCourses = [];
    let allStudents = [];
    let currentView = 'table';

    document.addEventListener('DOMContentLoaded', function() {
      checkTeacherAccess();
      loadData();
    });

    async function checkTeacherAccess() {
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');

      if (!token || !user) {
        window.location.href = 'signin.html';
        return;
      }

      if (user.role !== 'teacher') {
        alert('Access denied. Teachers only.');
        window.location.href = 'index.html';
        return;
      }
    }

    async function loadData() {
      try {
        // Load courses for filter
        const coursesResponse = await fetch('/api/courses', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        allCourses = await coursesResponse.json();

        // Load students for filter
        const studentsResponse = await fetch('/api/teachers/students', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        allStudents = await studentsResponse.json();

        // Load progress data
        const progressResponse = await fetch('/api/teachers/students/progress', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        allProgress = await progressResponse.json();

        populateFilters();
        displayProgress();
      } catch (error) {
        console.error('Error loading data:', error);
        alert('Error loading dashboard data');
      }
    }

    function populateFilters() {
      const courseFilter = document.getElementById('courseFilter');
      const studentFilter = document.getElementById('studentFilter');

      allCourses.forEach(course => {
        const option = document.createElement('option');
        option.value = course._id;
        option.textContent = course.title;
        courseFilter.appendChild(option);
      });

      allStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student._id;
        option.textContent = student.username;
        studentFilter.appendChild(option);
      });
    }

    function filterProgress() {
      const courseFilter = document.getElementById('courseFilter').value;
      const studentFilter = document.getElementById('studentFilter').value;

      let filtered = allProgress;

      if (courseFilter) {
        filtered = filtered.filter(p => p.course._id === courseFilter);
      }

      if (studentFilter) {
        filtered = filtered.filter(p => p.student._id === studentFilter);
      }

      displayProgress(filtered);
    }

    function displayProgress(progressData = allProgress) {
      if (currentView === 'table') {
        displayTableView(progressData);
      } else {
        displayCardView(progressData);
      }
    }

    function displayTableView(progressData) {
      const tbody = document.getElementById('progressTableBody');
      tbody.innerHTML = '';

      progressData.forEach(progress => {
        const row = document.createElement('tr');

        row.innerHTML = `
          <td>${progress.student.username}</td>
          <td>${progress.course.title} (${progress.course.subject})</td>
          <td>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress.progressPercentage}%">
                ${progress.progressPercentage}%
              </div>
            </div>
          </td>
          <td>${new Date(progress.lastAccessedAt).toLocaleDateString()}</td>
          <td>
            ${progress.quizResults.map(result =>
              `<div>Quiz: ${result.score}/${result.totalQuestions} (${new Date(result.completedAt).toLocaleDateString()})</div>`
            ).join('')}
          </td>
          <td>
            <textarea class="notes-input" data-progress-id="${progress._id}" placeholder="Add notes...">${progress.notes || ''}</textarea>
            <button class="save-notes-btn" onclick="saveNotes('${progress._id}')">Save Notes</button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function displayCardView(progressData) {
      const cardsContainer = document.getElementById('progressCards');
      cardsContainer.innerHTML = '';

      progressData.forEach(progress => {
        const card = document.createElement('div');
        card.className = 'student-card';

        card.innerHTML = `
          <div class="student-name">${progress.student.username}</div>
          <div class="course-info">
            <strong>Course:</strong> ${progress.course.title} (${progress.course.subject})<br>
            <strong>Progress:</strong>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress.progressPercentage}%">
                ${progress.progressPercentage}%
              </div>
            </div>
            <strong>Last Accessed:</strong> ${new Date(progress.lastAccessedAt).toLocaleDateString()}
          </div>
          <div class="quiz-results">
            <strong>Quiz Results:</strong>
            ${progress.quizResults.map(result =>
              `<div class="quiz-result">
                Score: ${result.score}/${result.totalQuestions} (${new Date(result.completedAt).toLocaleDateString()})
              </div>`
            ).join('')}
          </div>
          <div>
            <strong>Notes:</strong><br>
            <textarea class="notes-input" data-progress-id="${progress._id}" placeholder="Add notes...">${progress.notes || ''}</textarea>
            <button class="save-notes-btn" onclick="saveNotes('${progress._id}')">Save Notes</button>
          </div>
        `;

        cardsContainer.appendChild(card);
      });
    }

    function switchView(view) {
      currentView = view;
      document.getElementById('tableView').style.display = view === 'table' ? 'block' : 'none';
      document.getElementById('cardView').style.display = view === 'card' ? 'block' : 'none';

      document.getElementById('tableViewBtn').classList.toggle('active', view === 'table');
      document.getElementById('cardViewBtn').classList.toggle('active', view === 'card');

      displayProgress();
    }

    async function saveNotes(progressId) {
      const textarea = document.querySelector(`[data-progress-id="${progressId}"]`);
      const notes = textarea.value;

      try {
        const response = await fetch(`/api/teachers/students/progress/${progressId}/notes`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ notes })
        });

        if (response.ok) {
          alert('Notes saved successfully');
        } else {
          alert('Error saving notes');
        }
      } catch (error) {
        console.error('Error saving notes:', error);
        alert('Error saving notes');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'signin.html';
    }
  </script>
</body>
</html>
